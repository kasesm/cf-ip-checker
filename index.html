<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø±Ø±Ø³ÛŒ IP Ù‡Ø§ÛŒ Cloudflare</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%23f6821f'/%3E%3Cstop offset='1' stop-color='%23fbad41'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M44 36c0-4.4-3.6-8-8-8-1.2 0-2.3.3-3.3.8C31.5 26.1 28.9 24 26 24c-4.4 0-8 3.6-8 8 0 .2 0 .4.01.6C15.7 33.4 14 35.5 14 38c0 3.3 2.7 6 6 6h22c3.3 0 6-2.7 6-6 0-1-.3-1.9-.7-2.7.5-.7.7-1.5.7-2.3z' fill='white'/%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --accent: #f6821f;
    --accent2: #fbad41;
    --green: #22d3a5;
    --red: #f43f5e;
    --yellow: #fbbf24;
    --text: #e2e8f0;
    --muted: #64748b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Vazirmatn', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(246,130,31,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(246,130,31,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 20px;
    position: relative;
    z-index: 1;
  }

  header {
    text-align: center;
    margin-bottom: 40px;
  }

  .logo {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }

  .logo-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 0 30px rgba(246,130,31,0.4);
  }

  h1 {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .subtitle {
    color: var(--muted);
    font-size: 0.9rem;
    margin-top: 8px;
  }

  .controls {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 1;
    min-width: 140px;
  }

  label {
    font-size: 0.75rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  input[type="number"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'Vazirmatn', sans-serif;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }

  input[type="number"]:focus {
    border-color: var(--accent);
  }

  .btn {
    padding: 12px 32px;
    border: none;
    border-radius: 10px;
    font-family: 'Vazirmatn', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
    box-shadow: 0 4px 20px rgba(246,130,31,0.35);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 28px rgba(246,130,31,0.5);
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* Stats bar */
  .stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .stat-total .stat-value { color: var(--text); }
  .stat-clean .stat-value { color: var(--green); }
  .stat-blocked .stat-value { color: var(--red); }
  .stat-pending .stat-value { color: var(--yellow); }

  /* Progress */
  .progress-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    height: 8px;
    margin-bottom: 24px;
    overflow: hidden;
    display: none;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 8px;
    width: 0%;
    transition: width 0.3s ease;
  }

  /* Filter tabs */
  .filter-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .tab {
    padding: 7px 18px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-family: 'Vazirmatn', sans-serif;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  /* Results grid */
  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 10px;
  }

  .ip-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .ip-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
  }

  .ip-card.clean { border-right: 3px solid var(--green); }
  .ip-card.blocked { border-right: 3px solid var(--red); }
  .ip-card.checking { border-right: 3px solid var(--yellow); }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .clean .status-dot { background: var(--green); box-shadow: 0 0 8px var(--green); }
  .blocked .status-dot { background: var(--red); }
  .checking .status-dot {
    background: var(--yellow);
    animation: pulse 1s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  .ip-info { flex: 1; min-width: 0; }

  .ip-addr {
    font-size: 0.9rem;
    font-weight: 600;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.02em;
    color: var(--text);
  }

  .ip-meta {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 2px;
  }

  .latency {
    font-size: 0.8rem;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 6px;
    white-space: nowrap;
  }

  .latency-fast { background: rgba(34,211,165,0.15); color: var(--green); }
  .latency-medium { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .latency-slow { background: rgba(244,63,94,0.15); color: var(--red); }
  .latency-blocked { background: rgba(100,116,139,0.15); color: var(--muted); }

  .copy-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 4px 8px;
    color: var(--muted);
    cursor: pointer;
    font-size: 0.7rem;
    transition: all 0.15s;
    font-family: 'Vazirmatn', sans-serif;
  }

  .copy-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .ports-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 4px;
  }

  .port-badge {
    font-size: 0.68rem;
    padding: 2px 7px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-weight: 600;
  }

  .port-open { background: rgba(34,211,165,0.15); color: var(--green); }
  .port-closed { background: rgba(244,63,94,0.1); color: var(--red); }
  .port-checking { background: rgba(251,191,36,0.1); color: var(--yellow); }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .empty-icon { font-size: 3rem; margin-bottom: 12px; }

  /* Export section */
  .export-section {
    margin-top: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    display: none;
  }

  .export-title {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 12px;
  }

  .clean-ips-list {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    color: var(--green);
    max-height: 120px;
    overflow-y: auto;
    line-height: 1.6;
    word-break: break-all;
    margin-bottom: 12px;
  }

  @media (max-width: 600px) {
    .stats { grid-template-columns: repeat(2, 1fr); }
    h1 { font-size: 1.4rem; }
    .controls { flex-direction: column; }
  }

  /* IP Range Manager */
  .range-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px 24px;
    margin-bottom: 24px;
  }

  .range-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    cursor: pointer;
    user-select: none;
  }

  .range-section-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .toggle-icon {
    font-size: 0.7rem;
    transition: transform 0.2s;
    color: var(--muted);
  }

  .range-section.collapsed .range-body { display: none; }
  .range-section.collapsed .toggle-icon { transform: rotate(-90deg); }

  .preset-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
  }

  .chip {
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--muted);
    font-size: 0.75rem;
    font-family: monospace;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .chip:hover { border-color: var(--accent); color: var(--accent); }
  .chip.active { background: rgba(246,130,31,0.15); border-color: var(--accent); color: var(--accent2); }

  .chip-label {
    font-family: 'Vazirmatn', sans-serif;
    font-size: 0.7rem;
    opacity: 0.7;
  }

  .range-input-area {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .range-input-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .range-input-row input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 9px 14px;
    color: var(--text);
    font-family: monospace;
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.2s;
  }

  .range-input-row input:focus { border-color: var(--accent); }
  .range-input-row input.invalid { border-color: var(--red); }

  .btn-icon {
    width: 34px;
    height: 34px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface2);
    color: var(--muted);
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
  }

  .btn-icon:hover { border-color: var(--red); color: var(--red); }
  .btn-icon.add:hover { border-color: var(--green); color: var(--green); }

  .add-range-btn {
    align-self: flex-start;
    margin-top: 4px;
    padding: 7px 16px;
    border: 1px dashed var(--border);
    border-radius: 8px;
    background: transparent;
    color: var(--muted);
    font-family: 'Vazirmatn', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .add-range-btn:hover { border-color: var(--accent); color: var(--accent); }

  .range-summary {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 10px;
  }

  .range-summary span { color: var(--accent2); font-weight: 600; }

</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">
      <div class="logo-icon">â˜ï¸</div>
      <h1>Ø¨Ø±Ø±Ø³ÛŒ IP Ù‡Ø§ÛŒ Cloudflare</h1>
    </div>
    <p class="subtitle">Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ IP Ù‡Ø§ÛŒ Cloudflare Ø§Ø² Ø§ÛŒÙ†ØªØ±Ù†Øª Ø´Ù…Ø§</p>
  </header>


  <!-- IP Range Manager -->
  <div class="range-section" id="rangeSection">
    <div class="range-section-header" onclick="toggleRangeSection()">
      <div class="range-section-title">
        ğŸ¯ Ø±ÛŒÙ†Ø¬â€ŒÙ‡Ø§ÛŒ IP Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù†
      </div>
      <span class="toggle-icon">â–¼</span>
    </div>
    <div class="range-body">
      <div style="font-size:0.78rem; color:var(--muted); margin-bottom:12px;">Ø±ÛŒÙ†Ø¬â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Cloudflare â€” Ú©Ù„ÛŒÚ© Ú©Ù† ØªØ§ Ø§Ø¶Ø§ÙÙ‡/Ø­Ø°Ù Ø¨Ø´Ù‡:</div>
      <div class="preset-chips" id="presetChips"></div>

      <div style="font-size:0.78rem; color:var(--muted); margin-bottom:8px;">Ø±ÛŒÙ†Ø¬â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ (CIDR):</div>
      <div class="range-input-area" id="customRanges"></div>
      <button class="add-range-btn" onclick="addRangeInput()">+ Ø§ÙØ²ÙˆØ¯Ù† Ø±ÛŒÙ†Ø¬ Ø¬Ø¯ÛŒØ¯</button>

      <div class="range-summary" id="rangeSummary"></div>
    </div>
  </div>

  <div class="controls">
    <div class="control-group">
      <label>ØªØ¹Ø¯Ø§Ø¯ IP Ø¨Ø±Ø§ÛŒ ØªØ³Øª</label>
      <input type="number" id="ipCount" value="50" min="10" max="200">
    </div>
    <div class="control-group">
      <label>ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª (Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡)</label>
      <input type="number" id="timeout" value="3000" min="1000" max="10000" step="500">
    </div>
    <div class="control-group">
      <label>Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†</label>
      <input type="number" id="concurrency" value="20" min="5" max="50">
    </div>
    <div class="control-group" style="flex: 2; min-width: 200px;">
      <label>Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†)</label>
      <input type="text" id="portInput" value="443, 2053, 8443" placeholder="443, 2053, 8443" style="font-family: monospace;">
    </div>
    <button class="btn btn-primary" id="startBtn" onclick="startCheck()">ğŸš€ Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒ</button>
    <button class="btn btn-secondary" id="stopBtn" onclick="stopCheck()" style="display:none">â¹ ØªÙˆÙ‚Ù</button>
  </div>

  <div class="stats">
    <div class="stat-card stat-total"><div class="stat-value" id="totalCount">0</div><div class="stat-label">Ú©Ù„ IP</div></div>
    <div class="stat-card stat-clean"><div class="stat-value" id="cleanCount">0</div><div class="stat-label">âœ… ØªÙ…ÛŒØ²</div></div>
    <div class="stat-card stat-blocked"><div class="stat-value" id="blockedCount">0</div><div class="stat-label">âŒ Ø¨Ù„Ø§Ú©</div></div>
    <div class="stat-card stat-pending"><div class="stat-value" id="pendingCount">0</div><div class="stat-label">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ</div></div>
  </div>

  <div class="progress-wrap" id="progressWrap">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <div class="filter-tabs">
    <button class="tab active" onclick="setFilter('all', this)">Ù‡Ù…Ù‡</button>
    <button class="tab" onclick="setFilter('clean', this)">ØªÙ…ÛŒØ²</button>
    <button class="tab" onclick="setFilter('blocked', this)">Ø¨Ù„Ø§Ú© Ø´Ø¯Ù‡</button>
    <button class="tab" onclick="setFilter('checking', this)">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ</button>
  </div>

  <div id="resultsGrid" class="results-grid">
    <div class="empty-state">
      <div class="empty-icon">ğŸŒ</div>
      <div>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒØŒ Ø¯Ú©Ù…Ù‡ Â«Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯</div>
    </div>
  </div>

  <div class="export-section" id="exportSection">
    <div class="export-title">IP Ù‡Ø§ÛŒ ØªÙ…ÛŒØ² (Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ):</div>
    <div class="clean-ips-list" id="cleanIpsList"></div>
    <button class="btn btn-secondary" onclick="copyCleanIPs()">ğŸ“‹ Ú©Ù¾ÛŒ Ù‡Ù…Ù‡ IP Ù‡Ø§ÛŒ ØªÙ…ÛŒØ²</button>
  </div>
</div>

<script>
// Cloudflare IP ranges (IPv4)
const CF_RANGES = [
  '103.21.244.0/22','103.22.200.0/22','103.31.4.0/22',
  '104.16.0.0/13','104.24.0.0/14','108.162.192.0/18',
  '131.0.72.0/22','141.101.64.0/18','162.158.0.0/15',
  '172.64.0.0/13','173.245.48.0/20','188.114.96.0/20',
  '190.93.240.0/20','197.234.240.0/22','198.41.128.0/17'
];

let results = {};
let shouldStop = false;
let currentFilter = 'all';
let selectedPort = [443];

function ipToInt(ip) {
  return ip.split('.').reduce((acc, b) => (acc << 8) | parseInt(b), 0) >>> 0;
}

function intToIp(n) {
  return [(n >>> 24) & 255, (n >>> 16) & 255, (n >>> 8) & 255, n & 255].join('.');
}

function generateIPs(count) {
  const ips = new Set();
  const ranges = getActiveRanges();
  if (ranges.length === 0) return [];
  const attempts = count * 10;
  for (let i = 0; i < attempts && ips.size < count; i++) {
    const range = ranges[Math.floor(Math.random() * ranges.length)];
    const [base, bits] = range.split('/');
    const prefix = parseInt(bits);
    const baseInt = ipToInt(base);
    const hostBits = 32 - prefix;
    const mask = (0xFFFFFFFF << hostBits) >>> 0;
    const network = baseInt & mask;
    const maxHost = Math.pow(2, hostBits) - 2;
    if (maxHost <= 0) continue;
    const offset = Math.floor(Math.random() * maxHost) + 1;
    ips.add(intToIp((network + offset) >>> 0));
  }
  return [...ips].slice(0, count);
}

async function checkIP(ip, timeoutMs) {
  const start = Date.now();
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);
  try {
    await fetch(`https://${ip}/cdn-cgi/trace`, {
      mode: 'no-cors',
      cache: 'no-store',
      signal: controller.signal
    });
    clearTimeout(timer);
    return { status: 'clean', latency: Date.now() - start };
  } catch (e) {
    clearTimeout(timer);
    if (e.name === 'AbortError') return { status: 'blocked', latency: null };
    // Even a CORS error means the server responded = accessible
    if (Date.now() - start < timeoutMs - 100) {
      return { status: 'clean', latency: Date.now() - start };
    }
    return { status: 'blocked', latency: null };
  }
}

function updateStats() {
  const all = Object.values(results);
  const clean = all.filter(r => r.status === 'clean').length;
  const blocked = all.filter(r => r.status === 'blocked').length;
  const checking = all.filter(r => r.status === 'checking').length;
  document.getElementById('totalCount').textContent = all.length;
  document.getElementById('cleanCount').textContent = clean;
  document.getElementById('blockedCount').textContent = blocked;
  document.getElementById('pendingCount').textContent = checking;

  // Update export
  const cleanIPs = all.filter(r => r.status === 'clean').map(r => r.ip);
  if (cleanIPs.length > 0) {
    document.getElementById('exportSection').style.display = 'block';
    document.getElementById('cleanIpsList').textContent = cleanIPs.join(', ');
  }
}

function getLatencyBadge(latency, status) {
  if (status === 'blocked') return `<span class="latency latency-blocked">Ø¨Ù„Ø§Ú©</span>`;
  if (status === 'checking') return `<span class="latency latency-medium">...</span>`;
  if (latency < 500) return `<span class="latency latency-fast">${latency}ms</span>`;
  if (latency < 1500) return `<span class="latency latency-medium">${latency}ms</span>`;
  return `<span class="latency latency-slow">${latency}ms</span>`;
}

function renderResults() {
  const grid = document.getElementById('resultsGrid');
  const all = Object.values(results);
  const filtered = currentFilter === 'all' ? all : all.filter(r => r.status === currentFilter);

  if (filtered.length === 0) {
    grid.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”</div><div>Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div></div>`;
    return;
  }

  // Sort: clean first, then by latency
  filtered.sort((a, b) => {
    if (a.status === 'clean' && b.status !== 'clean') return -1;
    if (b.status === 'clean' && a.status !== 'clean') return 1;
    if (a.latency && b.latency) return a.latency - b.latency;
    return 0;
  });

  grid.innerHTML = filtered.map(r => {
    let portsBadges = '';
    if (r.status === 'clean') {
      selectedPort.forEach(port => {
        const p = r.ports && r.ports[port];
        if (p === undefined || p === 'checking') {
          portsBadges += `<span class="port-badge port-checking">${port} Â·Â·Â·</span>`;
        } else if (p === true) {
          portsBadges += `<span class="port-badge port-open">${port} âœ“</span>`;
        } else {
          portsBadges += `<span class="port-badge port-closed">${port} âœ—</span>`;
        }
      });
    }
    return `
    <div class="ip-card ${r.status}">
      <div class="status-dot"></div>
      <div class="ip-info">
        <div class="ip-addr">${r.ip}</div>
        <div class="ip-meta">${r.status === 'clean' ? 'âœ… Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³' : r.status === 'blocked' ? 'âŒ Ø¨Ù„Ø§Ú© Ø´Ø¯Ù‡' : 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ'}</div>
        ${r.status === 'clean' ? `<div class="ports-wrap">${portsBadges}</div>` : ''}
      </div>
      ${getLatencyBadge(r.latency, r.status)}
      ${r.status === 'clean' ? `<button class="copy-btn" onclick="navigator.clipboard.writeText('${r.ip}')">Ú©Ù¾ÛŒ</button>` : ''}
    </div>
  `}).join('');
}

function setFilter(filter, el) {
  currentFilter = filter;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderResults();
}

let renderTimer = null;
function scheduleRender() {
  if (renderTimer) return;
  renderTimer = setTimeout(() => {
    renderResults();
    updateStats();
    renderTimer = null;
  }, 200);
}



async function checkPort(ip, port, timeoutMs) {
  const start = Date.now();
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);
  const protocol = (port === 80 || port === 8080) ? 'http' : 'https';
  try {
    await fetch(`${protocol}://${ip}:${port}/cdn-cgi/trace`, {
      mode: 'no-cors',
      cache: 'no-store',
      signal: controller.signal
    });
    clearTimeout(timer);
    return true;
  } catch(e) {
    clearTimeout(timer);
    if (e.name === 'AbortError') return false;
    return (Date.now() - start) < (timeoutMs - 200);
  }
}


// â”€â”€ Range Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRESET_RANGES = [
  { cidr: '103.21.244.0/22',  label: 'CF-1' },
  { cidr: '103.22.200.0/22',  label: 'CF-2' },
  { cidr: '103.31.4.0/22',    label: 'CF-3' },
  { cidr: '104.16.0.0/13',    label: 'CF-4 â­' },
  { cidr: '104.24.0.0/14',    label: 'CF-5 â­' },
  { cidr: '108.162.192.0/18', label: 'CF-6' },
  { cidr: '131.0.72.0/22',    label: 'CF-7' },
  { cidr: '141.101.64.0/18',  label: 'CF-8' },
  { cidr: '162.158.0.0/15',   label: 'CF-9 â­' },
  { cidr: '172.64.0.0/13',    label: 'CF-10 â­' },
  { cidr: '173.245.48.0/20',  label: 'CF-11' },
  { cidr: '188.114.96.0/20',  label: 'CF-12' },
  { cidr: '190.93.240.0/20',  label: 'CF-13' },
  { cidr: '197.234.240.0/22', label: 'CF-14' },
  { cidr: '198.41.128.0/17',  label: 'CF-15 â­' },
];

// â­ = Ø¨Ù‡ØªØ±ÛŒÙ† Ø±ÛŒÙ†Ø¬â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†
let activePresets = new Set(['104.16.0.0/13','104.24.0.0/14','162.158.0.0/15','172.64.0.0/13','198.41.128.0/17']);

function initRangeManager() {
  const chips = document.getElementById('presetChips');
  PRESET_RANGES.forEach(r => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (activePresets.has(r.cidr) ? ' active' : '');
    chip.innerHTML = `<span>${r.cidr}</span><span class="chip-label">${r.label}</span>`;
    chip.onclick = () => togglePreset(r.cidr, chip);
    chips.appendChild(chip);
  });
  updateRangeSummary();
}

function togglePreset(cidr, el) {
  if (activePresets.has(cidr)) {
    activePresets.delete(cidr);
    el.classList.remove('active');
  } else {
    activePresets.add(cidr);
    el.classList.add('active');
  }
  updateRangeSummary();
}

function addRangeInput(value = '') {
  const container = document.getElementById('customRanges');
  const row = document.createElement('div');
  row.className = 'range-input-row';
  row.innerHTML = `
    <input type="text" placeholder="Ù…Ø«Ø§Ù„: 1.2.3.0/24" value="${value}" oninput="validateRange(this); updateRangeSummary()">
    <button class="btn-icon" title="Ø­Ø°Ù" onclick="this.parentElement.remove(); updateRangeSummary()">âœ•</button>
  `;
  container.appendChild(row);
  row.querySelector('input').focus();
  updateRangeSummary();
}

function validateRange(input) {
  const val = input.value.trim();
  if (!val) { input.classList.remove('invalid'); return; }
  const valid = /^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/.test(val);
  input.classList.toggle('invalid', !valid);
}

function getCustomRanges() {
  return [...document.querySelectorAll('#customRanges input')]
    .map(i => i.value.trim())
    .filter(v => /^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/.test(v));
}

function getActiveRanges() {
  return [...activePresets, ...getCustomRanges()];
}

function updateRangeSummary() {
  const all = getActiveRanges();
  let total = 0;
  all.forEach(cidr => {
    const bits = parseInt(cidr.split('/')[1]);
    total += Math.max(0, Math.pow(2, 32 - bits) - 2);
  });
  const fmt = total > 1e6 ? (total/1e6).toFixed(1)+'M' : total > 1e3 ? (total/1e3).toFixed(0)+'K' : total;
  document.getElementById('rangeSummary').innerHTML =
    `<span>${all.length}</span> Ø±ÛŒÙ†Ø¬ ÙØ¹Ø§Ù„ â€” Ø­Ø¯ÙˆØ¯ <span>${fmt}</span> Ø¢Ø¯Ø±Ø³ IP Ù‚Ø§Ø¨Ù„ Ø§Ø³Ú©Ù†`;
}

function toggleRangeSection() {
  document.getElementById('rangeSection').classList.toggle('collapsed');
}

// Init on load
initRangeManager();

// â”€â”€ End Range Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function startCheck() {
  shouldStop = false;
  results = {};
  document.getElementById('exportSection').style.display = 'none';
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').style.display = '';
  document.getElementById('progressWrap').style.display = 'block';

  const count = parseInt(document.getElementById('ipCount').value);
  const timeout = parseInt(document.getElementById('timeout').value);
  const concurrency = parseInt(document.getElementById('concurrency').value);
  selectedPort = document.getElementById('portInput').value.split(',').map(p => parseInt(p.trim())).filter(p => p > 0 && p <= 65535);
  if (selectedPort.length === 0) selectedPort = [443];
  const ips = generateIPs(count);

  // Init all as checking
  ips.forEach(ip => { results[ip] = { ip, status: 'checking', latency: null }; });
  renderResults();
  updateStats();

  let done = 0;
  let idx = 0;

  async function worker() {
    while (idx < ips.length && !shouldStop) {
      const ip = ips[idx++];
      const res = await checkIP(ip, timeout);
      results[ip] = { ip, ...res, ports: {} };
      done++;
      const pct = (done / ips.length) * 100;
      document.getElementById('progressBar').style.width = pct + '%';
      scheduleRender();

      // If clean, check port 443 in background
      if (res.status === 'clean') {
        selectedPort.forEach(port => {
          results[ip].ports[port] = 'checking';
          checkPort(ip, port, timeout).then(open => {
            if (results[ip]) {
              results[ip].ports[port] = open;
              scheduleRender();
            }
          });
        });
      }
    }
  }

  const workers = Array.from({ length: Math.min(concurrency, ips.length) }, () => worker());
  await Promise.all(workers);

  // Final render
  clearTimeout(renderTimer);
  renderTimer = null;
  renderResults();
  updateStats();

  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').style.display = 'none';
  if (!shouldStop) {
    document.getElementById('progressBar').style.width = '100%';
    setTimeout(() => { document.getElementById('progressWrap').style.display = 'none'; }, 1500);
  }
}

function stopCheck() {
  shouldStop = true;
  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').style.display = 'none';
}

function copyCleanIPs() {
  const text = document.getElementById('cleanIpsList').textContent;
  navigator.clipboard.writeText(text).then(() => alert('âœ… Ú©Ù¾ÛŒ Ø´Ø¯!'));
}
</script>
</body>
</html>
